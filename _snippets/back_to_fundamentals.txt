---
title: Back2Fundamentals (Alpha)
---
local BOSS_DAMAGE_PERCENT = 125
local DODGE_STAMINA_REGEN_DELAY = 0.0 -- between 0 and 1
local PROC_CHANC = {
  scavenger_get_ammo_on_kill = 1, --0.07,
  
  heal_permanent_proc_on_hit_melee = 0.07,
  heal_permanent_proc_on_kill_melee = 0.1,
  
  heal_permanent_proc_on_hit_ranged = 0.07,
  heal_permanent_proc_on_kill_ranged = 0.1
}
local MELEE_HP_TRAIT = "bloodlust_vt1_melee" -- or "regrowth_vt1_melee"
local RANGED_HP_TRAIT = "bloodlust_vt1_ranged" -- or "regrowth_vt1_ranged"


--Proc Functions for Buffs
ProcFunctions.heal_permanent_proc_on_hit_melee = function (player, buff, params)
	local player_unit = player.player_unit

	local hit_unit = params[1]
	local buff_type = params[6]
	local breed = AiUtils.unit_breed(hit_unit)

	if Unit.alive(player_unit) and Managers.player.is_server and breed and (buff_type == "MELEE_1H" or buff_type == "MELEE_2H") then
		local heal_amount = buff.bonus

		DamageUtils.heal_network(player_unit, player_unit, heal_amount, "career_passive")
		if player.local_player then
			mod:echo("Melee Regrowth awarded you 5 health!")
		end
	end
end

ProcFunctions.heal_permanent_proc_on_kill_melee = function (player, buff, params)
	local player_unit = player.player_unit

	local hit_unit = params[1]
	local damage_dealt = params[8] and params[8].damage_amount or 0
	local buff_type = params[6]
	local breed = AiUtils.unit_breed(hit_unit)

	local target_health_extension = ScriptUnit.extension(hit_unit, "health_system")
	local killing_blow = target_health_extension:current_health() < damage_dealt

	if Unit.alive(player_unit) and Managers.player.is_server and breed and (buff_type == "MELEE_1H" or buff_type == "MELEE_2H") and killing_blow then
		local heal_amount = buff.bonus

		DamageUtils.heal_network(player_unit, player_unit, heal_amount, "career_passive")
		if player.local_player then
			mod:echo("Melee Bloodlust awarded you 10 health!")
		end
	end
end

ProcFunctions.heal_permanent_proc_on_hit_ranged = function (player, buff, params)
	local player_unit = player.player_unit

	local hit_unit = params[1]
	local buff_type = params[6]
	local breed = AiUtils.unit_breed(hit_unit)

	if Unit.alive(player_unit) and Managers.player.is_server and breed and (buff_type == "RANGED" or buff_type == "RANGED_ABILITY") then
		local heal_amount = buff.bonus

		DamageUtils.heal_network(player_unit, player_unit, heal_amount, "career_passive")
		if player.local_player then
			mod:echo("Ranged Regrowth awarded you 5 health!")
		end
	end
end

ProcFunctions.heal_permanent_proc_on_kill_ranged = function (player, buff, params)
	local player_unit = player.player_unit

	local hit_unit = params[1]
	local damage_dealt = params[8] and params[8].damage_amount or 0
	local buff_type = params[6]
	local breed = AiUtils.unit_breed(hit_unit)

	local target_health_extension = ScriptUnit.extension(hit_unit, "health_system")
	local killing_blow = target_health_extension:current_health() < damage_dealt

	if Unit.alive(player_unit) and Managers.player.is_server and breed and (buff_type == "RANGED" or buff_type == "RANGED_ABILITY") and killing_blow then
		local heal_amount = buff.bonus

		DamageUtils.heal_network(player_unit, player_unit, heal_amount, "career_passive")
		if player.local_player then
			mod:echo("Ranged Bloodlust awarded you 10 health!")
		end
	end
end

ProcFunctions.scavenger_get_ammo_on_kill = function (player, buff, params)
	local player_unit = player.player_unit

	local hit_unit = params[1]
	local damage_dealt = params[8] and params[8].damage_amount or 0
	local buff_type = params[6]
	local breed = AiUtils.unit_breed(hit_unit)

	local target_health_extension = ScriptUnit.extension(hit_unit, "health_system")
	local killing_blow = target_health_extension:current_health() < damage_dealt

	if Unit.alive(player_unit) and Managers.player.is_server and breed and (buff_type == "RANGED" or buff_type == "RANGED_ABILITY") and killing_blow then	
			local buff_template = buff.template
			local weapon_slot = "slot_ranged"
			local inventory_extension = ScriptUnit.extension(player_unit, "inventory_system")
			local slot_data = inventory_extension:get_slot_data(weapon_slot)
			local right_unit_1p = slot_data.right_unit_1p
			local left_unit_1p = slot_data.left_unit_1p
			local right_hand_ammo_extension = ScriptUnit.has_extension(right_unit_1p, "ammo_system")
			local left_hand_ammo_extension = ScriptUnit.has_extension(left_unit_1p, "ammo_system")
			local ammo_extension = right_hand_ammo_extension or left_hand_ammo_extension
			local ammo_bonus_fraction = mod:get("scavenger_ammo_regen") --buff_template.ammo_bonus_fraction
			local ammo_amount = math.max(math.round(ammo_extension:max_ammo() * ammo_bonus_fraction), 1)
			if ammo_extension then
				ammo_extension:add_ammo_to_reserve(ammo_amount)
				if player.local_player then
					mod:echo("Scavenger awarded you " .. tostring(ammo_amount) .. " ammunition!")
				end
			end
	end
end

--Buffs

--Regrowth/Bloodlust
BuffTemplates.regrowth_vt1_melee = {
	name = "regrowth_vt1_melee",
	buffs = {
		{
			proc_chance = PROC_CHANCE.heal_permanent_proc_on_hit_melee,
			event_buff = true,
			event = "on_damage_dealt",
			buff_func = "heal_permanent_proc_on_hit_melee",
			bonus = 5
		}
	}
}
BuffTemplates.bloodlust_vt1_melee = {
	name = "bloodlust_vt1_melee",
	buffs = {
		{
			proc_chance = PROC_CHANCE.heal_permanent_proc_on_kill_melee,
			event_buff = true,
			event = "on_damage_dealt",
			buff_func = "heal_permanent_proc_on_kill_melee",
			bonus = 10
		}
	}
}
BuffTemplates.regrowth_vt1_ranged = {
	name = "regrowth_vt1_ranged",
	buffs = {
		{
			proc_chance = PROC_CHANCE.heal_permanent_proc_on_hit_ranged,
			event_buff = true,
			event = "on_damage_dealt",
			buff_func = "heal_permanent_proc_on_hit_ranged",
			bonus = 5
		}
	}
}
BuffTemplates.bloodlust_vt1_ranged = {
	name = "bloodlust_vt1_ranged",
	buffs = {
		{
			proc_chance = PROC_CHANCE.heal_permanent_proc_on_kill_ranged,
			event_buff = true,
			event = "on_damage_dealt",
			buff_func = "heal_permanent_proc_on_kill_ranged",
			bonus = 10
		}
	}
}

--Scavenger
BuffTemplates.scavenger_vt1 = {
	name = "scavenger_vt1",
	buffs = {
		{
			proc_chance = PROC_CHANCE.scavenger_get_ammo_on_kill,
			event_buff = true,
			event = "on_damage_dealt",
			buff_func = "scavenger_get_ammo_on_kill",
			ammo_bonus_fraction = 0.05
		},
	}
}

-- debug proc chances
mod:hook(BuffExtension, "has_procced", function (func, self, proc_chance, buff)
  local chance = PROC_CHANCE[buff.buff_func] or proc_chance
  return func(self, chance, buff)
end)

-- Adding buffs through talent
mod:hook(TalentExtension, "apply_buffs_from_talents", function (func, self, talent_ids)
	local hero_name = self._hero_name
	local buff_extension = self.buff_extension
	local player = self.player

	self:_clear_buffs_from_talents()

	local talent_buff_ids = self._talent_buff_ids
	local is_server_bot = self.is_server and player.bot_player
	local talents = Talents[hero_name]

	if not talents then
		return
	end
	
  do
		local id = buff_extension:add_buff(MELEE_HP_TRAIT)
		talent_buff_ids[#talent_buff_ids + 1] = id
  end
  do
		local id = buff_extension:add_buff(RANGED_HP_TRAIT)
		talent_buff_ids[#talent_buff_ids + 1] = id
  end

	local buff_template = "scavenger_vt1"
	local id = buff_extension:add_buff("scavenger_vt1")
	talent_buff_ids[#talent_buff_ids + 1] = id
end)

--Removing traits and properties
mod:hook(GearUtils, "get_property_and_trait_buffs", function (func, backend_items, backend_id, buffs_table, only_no_wield_required)
    return buffs_table
end)

--dodge stam regen delay
mod:hook_safe(GenericStatusExtension, "add_fatigue_points", function(self, type)
	if type == "action_dodge" then
	  local t = Managers.time:time("game")
	  self.last_fatigue_gain_time = t - (1 - DODGE_STAMINA_REGEN_DELAY)
	end
 end)

--boss/lord damage multiplier
mod:hook(DamageUtils, "calculate_damage", function(func, damage_output, target_unit, attacker_unit, hit_zone_name,
	original_power_level, boost_curve, boost_damage_multiplier, is_critical_strike, damage_profile, target_index, backstab_multiplier, damage_source)
		local dmg = func(damage_output, target_unit, attacker_unit, hit_zone_name, original_power_level,
		boost_curve, boost_damage_multiplier, is_critical_strike, damage_profile, target_index, backstab_multiplier, damage_source)
	
		if target_unit then
			local breed = Unit.get_data(target_unit, "breed")
			if breed and breed.boss then
				dmg = dmg * BOSS_DAMAGE_PERCENT / 100
				return dmg
			end
		end
	
		return dmg
end)

--no invisibility
mod:hook(GenericStatusExtension, "set_invisible", function (func, self, invisible, force_third_person)
    return
end)
